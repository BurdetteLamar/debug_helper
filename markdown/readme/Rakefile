require 'markdown_helper'

namespace :readme do

  desc 'Build README.md'
  task :build do
    # cats_for_class_dir_names = {
    #     :array => %w/simple/,
    #     :hash => {},
    #     :struct => {},
    #     :string => {},
    #     :symbol => {},
    # }
    # 
    # Make output files.
    class_dir_names = nil
    Dir.chdir('classes') do
      class_dir_names = Dir.glob('*').select {|f| File.directory? f}
      class_dir_names.each do |class_dir_name|
        Dir.chdir(class_dir_name) do
          case_dir_names = Dir.glob('*').select {|f| File.directory? f}
          case_dir_names.each do |case_dir_name|
            Dir.chdir(case_dir_name) do
              command = "ruby show.rb > show.yaml"
              system(command)
              command = "markdown_helper include --pristine template.md show.md"
              system(command)
            end
          end
        end
      end
    end
    # Make list of links to class sections.
    File.open('class_links.md', 'w') do |file|
      class_dir_names.each do |class_name|
        link_line = "- [#{class_name}](##{class_name})"
        file.puts(link_line)
      end
    end
    # Make inclusions for class sections.
    File.open('class_inclusions.md', 'w') do |file|
      class_dir_names.each do |class_name|
        inclusion_line = "@[:markdown](classes/#{class_name}/template.md)"
        file.puts(inclusion_line)
      end
    end
    markdown_helper = MarkdownHelper.new(:pristine => true)
    markdown_helper.include('template.md', 'README.md')

  end
end